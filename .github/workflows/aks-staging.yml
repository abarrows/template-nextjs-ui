name: 'Staging AKS Deploy'

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '**.ps1'
      - 'Secrets.json'
      - '.*ignore'
      - '**.gpg'
      - '/.devcontainer/'
      - '/.vscode/'

jobs:
  deploy:
    name: Execute AKS Deployment
    uses: Andrews-McMeel-Universal/reusable_workflows/.github/workflows/aks-deploy.yaml@2.1.15
    with:
      repositoryName: ${{ github.event.repository.name }}
      environment: staging
      environmentKeyVault: appname-staging
      clusterName: amuaks201
      clusterResourceGroup: AMU_AKS_201
      aksIngressFqdn: amuaks201-staging-ingress.centralus.cloudapp.azure.com.
      dnsResourceGroup: AMU_DNS_RG
      chartsPath: ./deployments/charts/
      dockerFilePath: .
      dockerImageName: ${{ github.event.repository.name }}
      dockerImageTag: ${{ github.sha }}
      maximumReplicas: 4
      storageAccountName: amucloudapps
      appInfoTableName: DeployedApplications
      deploymentTimeout: 20
      webAuthentication: false
      ingressWhitelist: '0.0.0.0/0'
      adminIngressWhitelist: '207.67.20.252'
      environmentIngress: true
    secrets:
      azureCredentials: ${{ secrets.AZURE_CREDENTIALS }}
      registryUserName: ${{ secrets.AMUAPPIMAGES201_USERNAME }}
      registryPassword: ${{ secrets.AMUAPPIMAGES201_PASSWORD }}
      storageAccountKey: ${{ secrets.AMUCLOUDAPPS_KEY }}

  update_boley_dns:
    needs: deploy
    name: Update Boley DNS
    uses: Andrews-McMeel-Universal/reusable_workflows/.github/workflows/update-addns.yaml@2.1.15
    with:
      environment: staging
      repositoryName: ${{ github.event.repository.name }}
      storageAccountName: amucloudapps
      appInfoTableName: DeployedApplications
    secrets:
      domainController: ${{ secrets.BOLEY_DC }}
      storageAccountKey: ${{ secrets.AMUCLOUDAPPS_KEY }}